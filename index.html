<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>توصيات-ياسر</title>
    <!-- Load Chart.js first -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <!-- Then load the date adapter -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.3.0/dist/chartjs-adapter-date-fns.min.js"></script>
    <!-- Finally load the financial chart extension -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@1.2.0/dist/chartjs-chart-financial.min.js"></script>
    
    <style>
        /* ... (ابقى على أنماط CSS كما هي) ... */
    </style>
</head>
<body>
    <!-- ... (ابقى على هيكل HTML كما هو) ... -->

    <script>
        // دالة لضمان تحميل المكتبات
        function waitForLibraries() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 10;
                const interval = setInterval(() => {
                    if (window.Chart && window.Chart.controllers && window.Chart.controllers.candlestick) {
                        clearInterval(interval);
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        clearInterval(interval);
                        reject(new Error('فشل في تحميل المكتبات المطلوبة'));
                    }
                    attempts++;
                }, 100);
            });
        }

        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // انتظر تحميل المكتبات
                await waitForLibraries();
                
                // تأكد من وجود جميع العناصر المطلوبة
                const requiredElements = [
                    'analyze-btn', 'refresh-btn', 'interval', 'limit',
                    'loading', 'error', 'recommendations-container', 'darkModeToggle'
                ];
                
                requiredElements.forEach(id => {
                    if (!document.getElementById(id)) {
                        throw new Error(`العنصر #${id} غير موجود في الصفحة`);
                    }
                });

                const analyzeBtn = document.getElementById('analyze-btn');
                const refreshBtn = document.getElementById('refresh-btn');
                const intervalSelect = document.getElementById('interval');
                const limitSelect = document.getElementById('limit');
                const loadingEl = document.getElementById('loading');
                const errorEl = document.getElementById('error');
                const recommendationsContainer = document.getElementById('recommendations-container');
                const darkModeToggle = document.getElementById('darkModeToggle');
                
                // Dark Mode Toggle
                if (localStorage.getItem('darkMode') === 'enabled') {
                    document.body.classList.add('dark-mode');
                    darkModeToggle.textContent = '☀️ الوضع النهاري';
                }
                
                darkModeToggle.addEventListener('click', () => {
                    document.body.classList.toggle('dark-mode');
                    const isDarkMode = document.body.classList.contains('dark-mode');
                    
                    darkModeToggle.textContent = isDarkMode ? '☀️ الوضع النهاري' : '🌙 الوضع الليلي';
                    localStorage.setItem('darkMode', isDarkMode ? 'enabled' : 'disabled');
                    
                    // إعادة تحميل البيانات عند تغيير الوضع
                    if (recommendationsContainer.innerHTML !== '') {
                        analyzeCoins();
                    }
                });
                
                // ... (ابقى على بقية الدوال كما هي) ...

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('error').textContent = error.message;
                document.getElementById('error').style.display = 'block';
            }
        });
    </script>
</body>
</html>
