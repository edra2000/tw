<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <!-- باقي الهيد بدون تغيير -->
</head>
<body>
    <!-- باقي البودي بدون تغيير حتى السكربت -->

    <script>
        // ... (باقي الدوال كما هي حتى calculateRSI)

        function calculateRSI(closes, period = 14) {
            if (closes.length < period) return Array(closes.length).fill(50);
            
            const rsiValues = [];
            let avgGain = 0;
            let avgLoss = 0;
            
            // حساب القيم الأولية
            for (let i = 1; i <= period; i++) {
                const diff = closes[i] - closes[i-1];
                if (diff >= 0) avgGain += diff;
                else avgLoss -= diff;
            }
            
            avgGain /= period;
            avgLoss /= period;
            
            // القيمة الأولى لـ RSI
            let rs = avgLoss === 0 ? 100 : avgGain / avgLoss;
            rsiValues.push(100 - (100 / (1 + rs)));
            
            // حساب بقية القيم
            for (let i = period + 1; i < closes.length; i++) {
                const diff = closes[i] - closes[i-1];
                let gain = 0;
                let loss = 0;
                
                if (diff >= 0) gain = diff;
                else loss = -diff;
                
                avgGain = (avgGain * (period - 1) + gain) / period;
                avgLoss = (avgLoss * (period - 1) + loss) / period;
                
                rs = avgLoss === 0 ? 100 : avgGain / avgLoss;
                rsiValues.push(100 - (100 / (1 + rs)));
            }
            
            // تعبئة القيم المفقودة بـ 50
            return Array(closes.length - rsiValues.length).fill(50).concat(rsiValues);
        }

        function calculateMACD(closes, fastPeriod = 12, slowPeriod = 26, signalPeriod = 9) {
            const fastEMA = calculateEMA(closes, fastPeriod);
            const slowEMA = calculateEMA(closes, slowPeriod);
            
            // حساب خط MACD
            const macdLine = [];
            for (let i = 0; i < closes.length; i++) {
                macdLine.push(fastEMA[i] - slowEMA[i]);
            }
            
            // حساب خط الإشارة (EMA لخط MACD)
            const signalLine = calculateEMA(macdLine, signalPeriod);
            
            // حساب الهيستوجرام
            const histogram = [];
            for (let i = 0; i < closes.length; i++) {
                histogram.push(macdLine[i] - signalLine[i]);
            }
            
            return {
                macdLine,
                signalLine,
                histogram
            };
        }

        function renderIndicators(coin) {
            const isDarkMode = document.body.classList.contains('dark-mode');
            const labels = Array.from({length: coin.history.length}, (_, i) => ``);

            // إصلاح مشكلة MACD المنقط
            const macdCtx = document.getElementById(`macd-${coin.symbol}`).getContext('2d');
            new Chart(macdCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'MACD Line',
                            data: coin.macd.macdLine,
                            borderColor: isDarkMode ? '#bb86fc' : '#3498db',
                            borderWidth: 2,
                            tension: 0.1,
                            pointRadius: 0 // إزالة النقاط
                        },
                        {
                            label: 'Signal Line',
                            data: coin.macd.signalLine,
                            borderColor: isDarkMode ? '#ff9800' : '#e91e63',
                            borderWidth: 2,
                            tension: 0.1,
                            pointRadius: 0 // إزالة النقاط
                        },
                        {
                            label: 'Histogram',
                            data: coin.macd.histogram,
                            type: 'bar',
                            backgroundColor: isDarkMode ? 
                                coin.macd.histogram.map(val => val >= 0 ? 'rgba(76, 175, 80, 0.8)' : 'rgba(244, 67, 54, 0.8)') : 
                                coin.macd.histogram.map(val => val >= 0 ? 'rgba(46, 204, 113, 0.6)' : 'rgba(231, 76, 60, 0.6)'),
                            borderColor: 'transparent',
                            borderWidth: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { 
                            display: true, 
                            grid: { color: isDarkMode ? '#444' : '#eee' },
                            ticks: { color: isDarkMode ? '#e0e0e0' : '#666' }
                        }
                    }
                }
            });

            // إصلاح مشكلة RSI
            const rsiCtx = document.getElementById(`rsi-${coin.symbol}`).getContext('2d');
            new Chart(rsiCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'RSI (14)',
                        data: coin.rsi,
                        borderColor: isDarkMode ? '#4caf50' : '#8bc34a',
                        borderWidth: 2,
                        tension: 0.1,
                        pointRadius: 0 // إزالة النقاط
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        annotation: {
                            annotations: {
                                line30: {
                                    type: 'line',
                                    yMin: 30,
                                    yMax: 30,
                                    borderColor: isDarkMode ? '#ff9800' : '#e91e63',
                                    borderWidth: 1,
                                    borderDash: [6, 6]
                                },
                                line70: {
                                    type: 'line',
                                    yMin: 70,
                                    yMax: 70,
                                    borderColor: isDarkMode ? '#ff9800' : '#e91e63',
                                    borderWidth: 1,
                                    borderDash: [6, 6]
                                }
                            }
                        }
                    },
                    scales: {
                        x: { display: false },
                        y: { 
                            display: true,
                            min: 0,
                            max: 100,
                            grid: { color: isDarkMode ? '#444' : '#eee' },
                            ticks: { 
                                color: isDarkMode ? '#e0e0e0' : '#666',
                                stepSize: 10
                            }
                        }
                    }
                }
            });

            // ... (باقي الدوال بدون تغيير)
        }
    </script>
</body>
</html>
